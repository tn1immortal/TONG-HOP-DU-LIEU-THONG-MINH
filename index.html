<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Tổng Hợp & OCR Đa Năng (Có Backup)</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    
    <!-- 3. Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .loader-dots:after { content: ' .'; animation: dots 1s steps(5, end) infinite;}
        @keyframes dots { 0%, 20% { color: rgba(0,0,0,0); text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0);} 40% { color: white; text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0);} 60% { text-shadow: .25em 0 0 white, .5em 0 0 rgba(0,0,0,0);} 80%, 100% { text-shadow: .25em 0 0 white, .5em 0 0 white;}}
        
        /* Hiệu ứng khi kéo thả */
        .droppable-hover { border: 2px dashed #2563eb !important; background-color: #eff6ff; }
        .item-droppable-hover { border-top: 2px solid #2563eb; }
        
        /* Highlight Animation */
        .highlight-match { background-color: #fde047; color: #000; border-radius: 2px; padding: 0 2px; font-weight: 600; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- ICON COMPONENTS ---
        const IconWrapper = ({ children, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );
        const Upload = ({ className }) => <IconWrapper className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></IconWrapper>;
        const RefreshCw = ({ className }) => <IconWrapper className={className}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></IconWrapper>;
        const Search = ({ className }) => <IconWrapper className={className}><circle cx="11" cy="11" r="8"/><line x1="21" x2="16.65" y1="21" y2="16.65"/></IconWrapper>;
        const FileText = ({ className }) => <IconWrapper className={className}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></IconWrapper>;
        const Download = ({ className }) => <IconWrapper className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></IconWrapper>;
        const BrainCircuit = ({ className }) => <IconWrapper className={className}><path d="M12 5a3 3 0 1 0-5.997.125 4 4 0 0 0-2.526 5.77 4 4 0 0 0 .556 6.588A4 4 0 1 0 12 18Z"/><path d="M12 5a3 3 0 1 1 5.997.125 4 4 0 0 1 2.526 5.77 4 4 0 0 1-.556 6.588A4 4 0 1 1 12 18Z"/><path d="M15 13a4.5 4.5 0 0 1-3-4 4.5 4.5 0 0 1-3 4"/><path d="M17.599 6.5a3 3 0 0 0 .399-1.375"/><path d="M6.003 5.125A3 3 0 0 0 6.401 6.5"/><path d="M3.477 10.896a4 4 0 0 1 .585-.396"/><path d="M19.938 10.5a4 4 0 0 1 .585.396"/><path d="M6 18a4 4 0 0 1-1.97-3.284"/><path d="M17.97 14.716A4 4 0 0 1 16 18"/></IconWrapper>;
        const ListIcon = ({ className }) => <IconWrapper className={className}><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></IconWrapper>;
        const GridIcon = ({ className }) => <IconWrapper className={className}><rect width="7" height="7" x="3" y="3" rx="1"/><rect width="7" height="7" x="14" y="3" rx="1"/><rect width="7" height="7" x="14" y="14" rx="1"/><rect width="7" height="7" x="3" y="14" rx="1"/></IconWrapper>;
        const BookOpen = ({ className }) => <IconWrapper className={className}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></IconWrapper>;
        const CheckCircle = ({ className }) => <IconWrapper className={className}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></IconWrapper>;
        const Trash2 = ({ className }) => <IconWrapper className={className}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconWrapper>;
        const Edit2 = ({ className }) => <IconWrapper className={className}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></IconWrapper>;
        const Save = ({ className }) => <IconWrapper className={className}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconWrapper>;
        const X = ({ className }) => <IconWrapper className={className}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></IconWrapper>;
        const Plus = ({ className }) => <IconWrapper className={className}><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></IconWrapper>;
        const Lock = ({ className }) => <IconWrapper className={className}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></IconWrapper>;
        const ImagePlus = ({ className }) => <IconWrapper className={className}><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h7"/><line x1="16" x2="22" y1="5" y2="5"/><line x1="19" x2="19" y1="2" y2="8"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></IconWrapper>;
        const GripVertical = ({ className }) => <IconWrapper className={className}><circle cx="9" cy="12" r="1"/><circle cx="9" cy="5" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="19" r="1"/></IconWrapper>;
        // New Icons for Backup/Restore
        const DownloadCloud = ({ className }) => <IconWrapper className={className}><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><polyline points="12 12 12 21"/><polyline points="8 17 12 21 16 17"/></IconWrapper>;
        const UploadCloud = ({ className }) => <IconWrapper className={className}><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><polyline points="12 12 12 21"/><polyline points="16 16 12 12 8 16"/><line x1="12" x2="12" y1="12" y2="21"/></IconWrapper>;
        const Database = ({ className }) => <IconWrapper className={className}><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></IconWrapper>;

        // --- CẤU HÌNH CDN ---
        const LIBS = {
            PDF: "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js",
            PDF_WORKER: "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js",
            EXCEL: "https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js",
            WORD: "https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js",
            TESSERACT: "https://unpkg.com/tesseract.js@4.1.1/dist/tesseract.min.js"
        };

        // --- NLP UTILS ---
        const removeVietnameseTones = (str) => {
            if (!str) return "";
            str = str.normalize('NFC');
            str = str.replace(/à|á|ạ|ả|ã|â|ầ|ấ|ậ|ẩ|ẫ|ă|ằ|ắ|ặ|ẳ|ẵ/g, "a");
            str = str.replace(/è|é|ẹ|ẻ|ẽ|ê|ề|ế|ệ|ể|ễ/g, "e");
            str = str.replace(/ì|í|ị|ỉ|ĩ/g, "i");
            str = str.replace(/ò|ó|ọ|ỏ|õ|ô|ồ|ố|ộ|ổ|ỗ|ơ|ờ|ớ|ợ|ở|ỡ/g, "o");
            str = str.replace(/ù|ú|ụ|ủ|ũ|ư|ừ|ứ|ự|ử|ữ/g, "u");
            str = str.replace(/ỳ|ý|ỵ|ỷ|ỹ/g, "y");
            str = str.replace(/đ/g, "d");
            str = str.replace(/À|Á|Ạ|Ả|Ã|Â|Ầ|Ấ|Ậ|Ẩ|Ẫ|Ă|Ằ|Ắ|Ặ|Ẳ|Ẵ/g, "A");
            str = str.replace(/È|É|Ẹ|Ẻ|Ẽ|Ê|Ề|Ế|Ệ|Ể|Ễ/g, "E");
            str = str.replace(/Ì|Í|Ị|Ỉ|Ĩ/g, "I");
            str = str.replace(/Ò|Ó|Ọ|Ỏ|Õ|Ô|Ồ|Ố|Ộ|Ổ|Ỗ|Ơ|Ờ|Ớ|Ợ|Ở|Ỡ/g, "O");
            str = str.replace(/Ù|Ú|Ụ|Ủ|Ũ|Ư|Ừ|Ứ|Ự|Ử|Ữ/g, "U");
            str = str.replace(/Ỳ|Ý|Ỵ|Ỷ|Ỹ/g, "Y");
            str = str.replace(/Đ/g, "D");
            str = str.replace(/\u0300|\u0301|\u0303|\u0309|\u0323/g, ""); 
            return str;
        }

        const toSentenceCase = (str) => {
            if (!str) return '';
            const s = str.toString().toLowerCase();
            return s.charAt(0).toUpperCase() + s.slice(1);
        }

        const cleanFileName = (fileName) => {
            if (!fileName) return "";
            let name = fileName.replace(/\.[^/.]+$/, "");
            name = name.replace(/[_-]/g, " ");
            name = name.replace(/\s+/g, " ").trim();
            return toSentenceCase(name);
        }

        const getBigrams = (str) => {
            const s = str.toLowerCase();
            const v = new Array(Math.max(0, s.length - 1));
            for (let i = 0; i < v.length; i++) v[i] = s.slice(i, i + 2);
            return v;
        }

        const calculateFuzzySimilarity = (str1, str2) => {
            if (!str1 || !str2) return 0;
            const s1 = removeVietnameseTones(str1).toLowerCase().replace(/\s+/g, '');
            const s2 = removeVietnameseTones(str2).toLowerCase().replace(/\s+/g, '');
            if (s1 === s2) return 1;
            if (s1.length < 2 || s2.length < 2) return 0;
            const bigrams1 = getBigrams(s1);
            const bigrams2 = getBigrams(s2);
            const sysBigrams = new Set(bigrams1);
            let intersection = 0;
            for (let i = 0; i < bigrams2.length; i++) {
                if (sysBigrams.has(bigrams2[i])) intersection++;
            }
            return (2.0 * intersection) / (bigrams1.length + bigrams2.length);
        };

        const hasVietnameseAccents = (str) => {
            return /[àáạảãâầấậẩẫăằắặẳẵèéẹẻẽêềếệểễìíịỉĩòóọỏõôồốộổỗơờớợởỡùúụủũưừứựửữỳýỵỷỹđ]/.test(str);
        }

        const generateId = () => Math.random().toString(36).substr(2, 9);

        const updateDictionary = (text, dictionary) => {
            if (!text || !hasVietnameseAccents(text)) return;
            const words = text.split(/[\s,.;:!?()"]+/);
            words.forEach(word => {
                if (word.length > 1 && hasVietnameseAccents(word)) {
                    const key = removeVietnameseTones(word).toLowerCase();
                    if (!dictionary[key]) dictionary[key] = word;
                    else if (word[0] === word[0].toUpperCase() && dictionary[key][0] !== dictionary[key][0].toUpperCase()) dictionary[key] = word;
                }
            });
        };

        const restoreAccents = (text, dictionary) => {
            if (!text) return '';
            const parts = text.split(/([\s,.;:!?()"]+)/);
            return parts.map(part => {
                const key = removeVietnameseTones(part).toLowerCase();
                return dictionary[key] || part;
            }).join('');
        };

        // --- HIGHLIGHT COMPONENT ---
        const HighlightText = ({ text, highlight }) => {
            if (!highlight || !text) return <span>{text}</span>;
            const normalizedText = removeVietnameseTones(text).toLowerCase();
            const normalizedHighlight = removeVietnameseTones(highlight).toLowerCase();
            if (!normalizedText.includes(normalizedHighlight)) return <span>{text}</span>;
            const parts = [];
            let currentIndex = 0;
            let searchIndex = normalizedText.indexOf(normalizedHighlight);
            while (searchIndex !== -1) {
                if (searchIndex > currentIndex) {
                    parts.push(<span key={currentIndex + 'pre'}>{text.substring(currentIndex, searchIndex)}</span>);
                }
                parts.push(
                    <span key={searchIndex + 'match'} className="highlight-match">
                        {text.substring(searchIndex, searchIndex + normalizedHighlight.length)}
                    </span>
                );
                currentIndex = searchIndex + normalizedHighlight.length;
                searchIndex = normalizedText.indexOf(normalizedHighlight, currentIndex);
            }
            if (currentIndex < text.length) {
                parts.push(<span key={currentIndex + 'post'}>{text.substring(currentIndex)}</span>);
            }
            return <>{parts}</>;
        };

        // --- MAIN APP COMPONENT ---
        const App = () => {
            const [knowledgeBase, setKnowledgeBase] = useState([]);
            const [accentDictionary, setAccentDictionary] = useState({});
            const [isProcessing, setIsProcessing] = useState(false);
            const [logs, setLogs] = useState([]);
            const [viewMode, setViewMode] = useState('dashboard');
            const [displayStyle, setDisplayStyle] = useState('document');
            const [searchTerm, setSearchTerm] = useState('');
            const [libsLoaded, setLibsLoaded] = useState(false);
            const [dragOverGroupId, setDragOverGroupId] = useState(null);
            
            const [manualText, setManualText] = useState("");
            const [editingId, setEditingId] = useState(null); 
            const [editValue, setEditValue] = useState("");   
            
            // Ref cho input file ẩn dùng để import
            const fileImportRef = useRef(null);

            useEffect(() => {
                const loadScript = (src) => {
                    return new Promise((resolve, reject) => {
                        if (document.querySelector(`script[src="${src}"]`)) {
                            resolve();
                            return;
                        }
                        const script = document.createElement('script');
                        script.src = src;
                        script.onload = resolve;
                        script.onerror = reject;
                        document.body.appendChild(script);
                    });
                };

                const loadAllLibs = async () => {
                    try {
                        await Promise.all([
                            loadScript(LIBS.PDF),
                            loadScript(LIBS.EXCEL),
                            loadScript(LIBS.WORD),
                            loadScript(LIBS.TESSERACT)
                        ]);
                        setLibsLoaded(true);
                        addLog("Đã tải xong bộ đọc: PDF, Excel, Word, OCR Hình Ảnh.");
                    } catch (err) {
                        console.error("Lỗi tải thư viện", err);
                        addLog("Lỗi: Không thể tải bộ đọc file. Kiểm tra kết nối mạng.");
                    }
                };

                loadAllLibs();

                const savedData = localStorage.getItem('vn_smart_knowledge_base');
                const savedDict = localStorage.getItem('vn_accent_dictionary');
                if (savedData) setKnowledgeBase(JSON.parse(savedData));
                if (savedDict) setAccentDictionary(JSON.parse(savedDict));
            }, []);

            useEffect(() => {
                localStorage.setItem('vn_smart_knowledge_base', JSON.stringify(knowledgeBase));
                localStorage.setItem('vn_accent_dictionary', JSON.stringify(accentDictionary));
            }, [knowledgeBase, accentDictionary]);

            const addLog = (message) => {
                setLogs(prev => [`[${new Date().toLocaleTimeString()}] ${message}`, ...prev.slice(0, 49)]);
            };

            // --- EXPORT & IMPORT DATA (NEW FEATURES) ---
            const handleExportData = () => {
                if (knowledgeBase.length === 0) {
                    alert("Chưa có dữ liệu để xuất!");
                    return;
                }
                const dataToExport = {
                    knowledgeBase: knowledgeBase,
                    accentDictionary: accentDictionary,
                    exportedAt: new Date().toISOString()
                };
                
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(dataToExport, null, 2));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", `Backup_DuLieu_${new Date().toISOString().slice(0,10)}.json`);
                document.body.appendChild(downloadAnchorNode); // required for firefox
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
                addLog("Đã xuất file backup dữ liệu (JSON).");
            };

            const handleImportClick = () => {
                if(fileImportRef.current) {
                    fileImportRef.current.click();
                }
            };

            const handleImportData = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        
                        // Basic validation
                        if (!importedData.knowledgeBase || !Array.isArray(importedData.knowledgeBase)) {
                            throw new Error("Cấu trúc file không hợp lệ.");
                        }

                        if (confirm(`Bạn có chắc muốn nạp dữ liệu backup? \nHành động này sẽ thay thế ${knowledgeBase.length} nhóm dữ liệu hiện tại bằng dữ liệu trong file.`)) {
                            setKnowledgeBase(importedData.knowledgeBase);
                            if (importedData.accentDictionary) {
                                setAccentDictionary(importedData.accentDictionary);
                            }
                            addLog(`Đã khôi phục dữ liệu từ backup: ${file.name}`);
                            setViewMode('dashboard');
                        }
                    } catch (error) {
                        console.error(error);
                        alert("Lỗi đọc file backup: " + error.message);
                        addLog("Lỗi đọc file backup.");
                    }
                    // Reset value để có thể chọn lại cùng 1 file
                    event.target.value = null; 
                };
                reader.readAsText(file);
            };

            // --- FILE READERS ---
            const readPdfFile = async (file) => {
                if (!window.pdfjsLib) throw new Error("Thư viện PDF chưa tải.");
                window.pdfjsLib.GlobalWorkerOptions.workerSrc = LIBS.PDF_WORKER;
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await window.pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                let fullText = "";
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(" ");
                    fullText += pageText + "\n";
                }
                return fullText;
            };

            const readWordFile = async (file) => {
                if (!window.mammoth) throw new Error("Thư viện Word chưa tải.");
                const arrayBuffer = await file.arrayBuffer();
                const result = await window.mammoth.extractRawText({ arrayBuffer });
                return result.value;
            };

            const readExcelFile = async (file) => {
                if (!window.XLSX) throw new Error("Thư viện Excel chưa tải.");
                const arrayBuffer = await file.arrayBuffer();
                const workbook = window.XLSX.read(arrayBuffer, { type: 'array' });
                let fullText = "";
                workbook.SheetNames.forEach(sheetName => {
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = window.XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    fullText += jsonData.map(row => row.join(" ")).join("\n") + "\n";
                });
                return fullText;
            };

            const readImageFile = async (file) => {
                if (!window.Tesseract) throw new Error("Thư viện OCR chưa tải.");
                addLog(`>> Đang quét OCR ảnh: ${file.name}. Quá trình này có thể mất vài giây...`);
                
                const { data: { text } } = await window.Tesseract.recognize(
                    file,
                    'vie', // Ngôn ngữ Tiếng Việt
                    { 
                        logger: m => {
                            if(m.status === 'recognizing text') {
                                // Có thể update progress ở đây nếu cần
                            }
                        } 
                    }
                );
                addLog(`>> Hoàn tất OCR ảnh: ${file.name}`);
                return text;
            };

            const handleManualUpload = () => {
                if (!manualText.trim()) return;
                setIsProcessing(true);
                addLog("Đang xử lý dữ liệu nhập thủ công...");
                const lines = manualText.split(/\r?\n/).filter(line => line.trim().length > 0);
                let allLines = lines.map(line => ({ content: line.trim(), source: "Nhập tay" }));
                processAndSave(allLines);
                setManualText("");
            };

            const handleFileUpload = async (event) => {
                const files = Array.from(event.target.files);
                if (files.length === 0) return;

                setIsProcessing(true);
                addLog(`Đang xử lý ${files.length} file...`);

                let allLines = [];

                for (const file of files) {
                    try {
                        let text = "";
                        const ext = file.name.split('.').pop().toLowerCase();
                        addLog(`-> Đọc file: ${file.name}`);

                        if (ext === 'pdf') text = await readPdfFile(file);
                        else if (ext === 'docx') text = await readWordFile(file);
                        else if (['xlsx', 'xls', 'csv'].includes(ext)) text = await readExcelFile(file);
                        else if (['png', 'jpg', 'jpeg', 'bmp', 'webp'].includes(ext)) {
                            text = await readImageFile(file);
                        } 
                        else if (['html', 'xml', 'htm', 'mhtml', 'mht'].includes(ext)) {
                            text = await new Promise(r => {
                                const reader = new FileReader();
                                reader.onload = (e) => r(e.target.result); 
                                reader.readAsText(file);
                            });
                            text = text.replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ');
                        } else {
                            text = await new Promise(r => {
                                const reader = new FileReader();
                                reader.onload = (e) => r(e.target.result);
                                reader.readAsText(file);
                            });
                        }

                        if (ext === 'json') {
                            try {
                                const j = JSON.parse(text);
                                text = JSON.stringify(j, null, 2).replace(/[{}[\],"]/g, ''); 
                            } catch(e) {}
                        }

                        const lines = text.split(/\r?\n/).filter(line => line.trim().length > 3);
                        lines.forEach(line => allLines.push({ content: line.trim(), source: file.name }));

                    } catch (err) {
                        console.error(err);
                        addLog(`⚠️ Lỗi đọc ${file.name}: ${err.message}.`);
                    }
                }

                processAndSave(allLines);
            };

            const processAndSave = (allLines) => {
                allLines.sort((a, b) => {
                    const aHas = hasVietnameseAccents(a.content);
                    const bHas = hasVietnameseAccents(b.content);
                    if (aHas && !bHas) return -1; 
                    if (!aHas && bHas) return 1;  
                    return 0;
                });

                let currentKB = [...knowledgeBase];
                let currentDict = { ...accentDictionary };
                
                knowledgeBase.forEach(group => {
                    if (hasVietnameseAccents(group.topic)) updateDictionary(group.topic, currentDict);
                    group.items.forEach(item => {
                        if (!item.isInferred) updateDictionary(item.content, currentDict);
                    });
                });

                let processedData = processBatchLogic(allLines, currentKB, currentDict);
                setAccentDictionary(processedData.dictionary);
                setKnowledgeBase(processedData.kb);
                
                setIsProcessing(false);
                addLog(`✅ Hoàn tất xử lý.`);
                setViewMode('dashboard');
            }

            const processBatchLogic = (lines, currentKB, currentDict) => {
                let newKB = JSON.parse(JSON.stringify(currentKB));
                
                for (const lineObj of lines) {
                    const rawContent = lineObj.content;
                    const fileTopic = cleanFileName(lineObj.source); 
                    
                    const hasAccent = hasVietnameseAccents(rawContent);
                    if (hasAccent) {
                        updateDictionary(rawContent, currentDict);
                        updateDictionary(fileTopic, currentDict);
                    }

                    let processedContent = rawContent;
                    let wasRestored = false;

                    if (!hasAccent) {
                        const restored = restoreAccents(rawContent, currentDict);
                        if (restored !== rawContent) {
                            processedContent = restored;
                            wasRestored = true;
                        }
                    }

                    let bestMatchGroupIndex = -1;
                    let bestMatchScore = 0;
                    const SIMILARITY_THRESHOLD = 0.55; 

                    newKB.forEach((group, index) => {
                        const filenameScore = calculateFuzzySimilarity(fileTopic, group.topic);
                        const topicScore = calculateFuzzySimilarity(processedContent, group.topic);
                        let itemMaxScore = 0;
                        group.items.slice(0, 20).forEach(item => {
                            const score = calculateFuzzySimilarity(processedContent, item.content);
                            if (score > itemMaxScore) itemMaxScore = score;
                        });
                        
                        const finalScore = Math.max(topicScore, itemMaxScore, filenameScore * 1.5); 

                        if (finalScore > bestMatchScore) {
                            bestMatchScore = finalScore;
                            bestMatchGroupIndex = index;
                        }
                    });

                    const newItem = {
                        id: generateId(),
                        content: processedContent,
                        originalContent: rawContent,
                        normalized: removeVietnameseTones(processedContent),
                        source: lineObj.source,
                        date: new Date().toISOString(),
                        isInferred: !hasAccent || wasRestored, 
                        confidenceScore: bestMatchScore > 1 ? 1 : bestMatchScore.toFixed(2)
                    };

                    if (bestMatchScore > SIMILARITY_THRESHOLD && bestMatchGroupIndex !== -1) {
                        const targetGroup = newKB[bestMatchGroupIndex];
                        const isDuplicate = targetGroup.items.some(i => 
                            i.content === processedContent || 
                            (i.originalContent && i.originalContent === rawContent)
                        );
                        
                        if (!isDuplicate) {
                            targetGroup.items.push(newItem);
                            targetGroup.lastUpdated = new Date().toISOString();
                            
                            if (!targetGroup.isManualTopic) {
                                const currentTopicHasAccent = hasVietnameseAccents(targetGroup.topic);
                                if (!currentTopicHasAccent && hasVietnameseAccents(fileTopic) && calculateFuzzySimilarity(fileTopic, targetGroup.topic) > 0.8) {
                                    targetGroup.topic = fileTopic;
                                } 
                                else if (!currentTopicHasAccent && hasVietnameseAccents(processedContent) && processedContent.length < 100) {
                                    targetGroup.topic = processedContent.length > 80 ? processedContent.substring(0, 80) + "..." : processedContent;
                                }
                            }
                        }
                    } else {
                        let newTopicName = fileTopic;
                        if (!newTopicName || newTopicName.length < 2 || newTopicName === "Nhap Tay") {
                            newTopicName = processedContent.length > 80 ? processedContent.substring(0, 80) + "..." : processedContent;
                        }
                        if (!hasVietnameseAccents(newTopicName)) {
                            const restoredTopic = restoreAccents(newTopicName, currentDict);
                            if (restoredTopic !== newTopicName) newTopicName = restoredTopic;
                        }

                        newKB.push({
                            id: generateId(),
                            topic: newTopicName, 
                            created: new Date().toISOString(),
                            lastUpdated: new Date().toISOString(),
                            items: [newItem],
                            isManualTopic: false 
                        });
                    }
                }
                newKB.sort((a, b) => new Date(b.lastUpdated) - new Date(a.lastUpdated));
                return { kb: newKB, dictionary: currentDict };
            };

            const handleClearData = () => {
                if(confirm("Xóa toàn bộ dữ liệu?")) {
                    setKnowledgeBase([]);
                    setAccentDictionary({});
                    localStorage.removeItem('vn_smart_knowledge_base');
                    localStorage.removeItem('vn_accent_dictionary');
                    addLog("Hệ thống đã reset.");
                }
            };

            const startEditing = (id, currentValue) => { setEditingId(id); setEditValue(currentValue); };
            const cancelEditing = () => { setEditingId(null); setEditValue(""); };

            const saveTopic = (groupId) => {
                const updatedKB = knowledgeBase.map(group => {
                    if (group.id === groupId) return { ...group, topic: editValue, isManualTopic: true };
                    return group;
                });
                setKnowledgeBase(updatedKB);
                cancelEditing();
                addLog("Đã cập nhật tên nhóm.");
            };

            const saveItem = (groupId, itemId) => {
                const updatedKB = knowledgeBase.map(group => {
                    if (group.id === groupId) {
                        const updatedItems = group.items.map(item => {
                            if (item.id === itemId) return { ...item, content: editValue };
                            return item;
                        });
                        return { ...group, items: updatedItems };
                    }
                    return group;
                });
                setKnowledgeBase(updatedKB);
                cancelEditing();
                addLog("Đã cập nhật nội dung.");
            };

            const deleteItem = (groupId, itemId) => {
                if(!confirm("Xóa mục này?")) return;
                const updatedKB = knowledgeBase.map(group => {
                    if (group.id === groupId) {
                        const updatedItems = group.items.filter(item => item.id !== itemId);
                        return { ...group, items: updatedItems };
                    }
                    return group;
                }).filter(group => group.items.length > 0); 
                setKnowledgeBase(updatedKB);
                addLog("Đã xóa mục.");
            };

            const handleExportReport = () => {
                let reportContent = "BÁO CÁO TỔNG HỢP\n";
                reportContent += `Ngày xuất: ${new Date().toLocaleString('vi-VN')}\n`;
                reportContent += "=============================================\n\n";
                knowledgeBase.forEach((group, index) => {
                    reportContent += `${index + 1}. ${toSentenceCase(group.topic)}\n`;
                    group.items.forEach(item => {
                        const mark = item.isInferred ? "[*]" : "";
                        reportContent += `   - ${toSentenceCase(item.content)} ${mark}\n`;
                    });
                    reportContent += "\n";
                });
                const element = document.createElement("a");
                const file = new Blob([reportContent], {type: 'text/plain'});
                element.href = URL.createObjectURL(file);
                element.download = `Bao_Cao_${new Date().toISOString().slice(0,10)}.txt`;
                document.body.appendChild(element);
                element.click();
            };

            // --- DRAG & DROP HANDLERS ---
            const handleDragStart = (e, groupId, itemId) => {
                e.dataTransfer.setData("application/json", JSON.stringify({ sourceGroupId: groupId, itemId }));
                e.dataTransfer.effectAllowed = "move";
            };

            const handleDragOver = (e, groupId) => {
                e.preventDefault(); 
                e.dataTransfer.dropEffect = "move";
                if (dragOverGroupId !== groupId) setDragOverGroupId(groupId);
            };

            const handleDragLeave = () => {
                setDragOverGroupId(null);
            };

            const handleDrop = (e, targetGroupId) => {
                e.preventDefault();
                setDragOverGroupId(null);
                const data = e.dataTransfer.getData("application/json");
                if (!data) return;
                
                try {
                    const { sourceGroupId, itemId } = JSON.parse(data);
                    if (sourceGroupId === targetGroupId) return; 

                    const newKB = [...knowledgeBase];
                    const sourceGroupIndex = newKB.findIndex(g => g.id === sourceGroupId);
                    if (sourceGroupIndex === -1) return;
                    
                    const itemIndex = newKB[sourceGroupIndex].items.findIndex(i => i.id === itemId);
                    if (itemIndex === -1) return;
                    
                    const [movedItem] = newKB[sourceGroupIndex].items.splice(itemIndex, 1);
                    
                    const targetGroupIndex = newKB.findIndex(g => g.id === targetGroupId);
                    if (targetGroupIndex !== -1) {
                        newKB[targetGroupIndex].items.push(movedItem);
                        newKB[targetGroupIndex].lastUpdated = new Date().toISOString();
                    }

                    if (newKB[sourceGroupIndex].items.length === 0) {
                        newKB.splice(sourceGroupIndex, 1);
                    }

                    setKnowledgeBase(newKB);
                    addLog("Đã chuyển mục sang nhóm mới.");

                } catch (err) {
                    console.error("Drop error", err);
                }
            };

            const handleItemDrop = (e, targetGroupId, targetItemId) => {
                e.preventDefault();
                e.stopPropagation(); 
                const data = e.dataTransfer.getData("application/json");
                if (!data) return;

                try {
                    const { sourceGroupId, itemId } = JSON.parse(data);
                    
                    const newKB = [...knowledgeBase];
                    const sourceGroupIndex = newKB.findIndex(g => g.id === sourceGroupId);
                    if (sourceGroupIndex === -1) return;
                    
                    const sourceItemIndex = newKB[sourceGroupIndex].items.findIndex(i => i.id === itemId);
                    if (sourceItemIndex === -1) return;
                    
                    const [movedItem] = newKB[sourceGroupIndex].items.splice(sourceItemIndex, 1);
                    const targetGroupIndex = newKB.findIndex(g => g.id === targetGroupId);
                    if (targetGroupIndex === -1) return;
                    
                    let targetItemIndex = newKB[targetGroupIndex].items.findIndex(i => i.id === targetItemId);
                    if (targetItemIndex !== -1) {
                        newKB[targetGroupIndex].items.splice(targetItemIndex, 0, movedItem);
                    } else {
                        newKB[targetGroupIndex].items.push(movedItem);
                    }
                    
                    if (sourceGroupId !== targetGroupId && newKB[sourceGroupIndex].items.length === 0) {
                        newKB.splice(sourceGroupIndex, 1);
                    }

                    newKB[targetGroupIndex].lastUpdated = new Date().toISOString();
                    setKnowledgeBase(newKB);
                    addLog(sourceGroupId === targetGroupId ? "Đã thay đổi thứ tự." : "Đã chuyển và chèn mục.");
                    
                } catch (err) {
                    console.error("Item Drop error", err);
                }
            };

            const filteredKB = knowledgeBase.map(group => {
                if (!searchTerm) return group;
                const normSearch = removeVietnameseTones(searchTerm).toLowerCase();
                const topicMatches = removeVietnameseTones(group.topic).toLowerCase().includes(normSearch);
                const matchingItems = group.items.filter(item => {
                    const contentMatch = (item.normalized || removeVietnameseTones(item.content)).toLowerCase().includes(normSearch);
                    const sourceMatch = removeVietnameseTones(item.source || "").toLowerCase().includes(normSearch);
                    return contentMatch || sourceMatch;
                });

                if (topicMatches) return group;
                if (matchingItems.length > 0) return { ...group, items: matchingItems };
                return null;
            }).filter(g => g !== null);

            return (
                <div className="flex h-screen bg-gray-100 text-gray-800 font-sans">
                    <div className="w-64 bg-white border-r border-gray-200 flex flex-col hidden md:flex shadow-sm z-20">
                        <div className="p-6 border-b border-gray-100">
                            <h1 className="text-xl font-bold text-slate-800 flex items-center gap-2">
                                <BrainCircuit className="w-7 h-7 text-blue-600" />
                                AI Super Reader
                            </h1>
                            <p className="text-xs text-gray-500 mt-1">OCR & Phục hồi dữ liệu</p>
                        </div>
                        
                        <nav className="flex-1 p-4 space-y-2 overflow-y-auto">
                            <button onClick={() => setViewMode('dashboard')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors ${viewMode === 'dashboard' ? 'bg-blue-50 text-blue-700 font-medium' : 'text-gray-600 hover:bg-gray-100'}`}>
                                <FileText className="w-5 h-5" /> Xem Báo Cáo
                            </button>
                            <button onClick={() => setViewMode('upload')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors ${viewMode === 'upload' ? 'bg-blue-50 text-blue-700 font-medium' : 'text-gray-600 hover:bg-gray-100'}`}>
                                <Upload className="w-5 h-5" /> Nạp Dữ Liệu
                            </button>

                            {/* --- QUẢN LÝ DỮ LIỆU SECTION --- */}
                            <div className="pt-4 mt-4 border-t border-gray-100">
                                <p className="px-4 text-xs font-semibold text-gray-400 uppercase mb-2">Quản lý dữ liệu</p>
                                
                                <button onClick={handleExportData} className="w-full flex items-center gap-3 px-4 py-2 text-sm rounded-lg text-green-700 hover:bg-green-50 transition-colors">
                                    <DownloadCloud className="w-4 h-4" /> Backup Dữ liệu
                                </button>
                                
                                <button onClick={handleImportClick} className="w-full flex items-center gap-3 px-4 py-2 text-sm rounded-lg text-amber-600 hover:bg-amber-50 transition-colors">
                                    <UploadCloud className="w-4 h-4" /> Khôi phục Dữ liệu
                                </button>
                                {/* Input ẩn cho Restore */}
                                <input 
                                    type="file" 
                                    ref={fileImportRef} 
                                    onChange={handleImportData} 
                                    className="hidden" 
                                    accept=".json"
                                />

                                <button onClick={handleClearData} className="w-full flex items-center gap-3 px-4 py-2 text-sm rounded-lg text-red-600 hover:bg-red-50 transition-colors mt-1">
                                    <Trash2 className="w-4 h-4" /> Xóa toàn bộ
                                </button>
                            </div>
                        </nav>

                        <div className="p-4 border-t border-gray-100 text-xs text-gray-500 bg-gray-50">
                            <div className="flex items-center gap-1 mb-1">
                                {libsLoaded ? <CheckCircle className="w-3 h-3 text-green-500" /> : <RefreshCw className="w-3 h-3 animate-spin text-orange-500" />}
                                Trạng thái: {libsLoaded ? "Sẵn sàng" : "Đang tải bộ đọc..."}
                            </div>
                            <div className="flex items-center gap-1 mb-1">
                                <Database className="w-3 h-3" /> Bản ghi: <span className="font-bold text-gray-800">{knowledgeBase.reduce((acc, g) => acc + g.items.length, 0)}</span>
                            </div>
                            <div className="flex items-center gap-1 mb-1">
                                <BookOpen className="w-3 h-3" /> Từ điển: <span className="font-bold text-gray-800">{Object.keys(accentDictionary).length}</span> từ
                            </div>
                        </div>
                    </div>

                    <div className="flex-1 flex flex-col overflow-hidden">
                        <header className="bg-white border-b border-gray-200 px-8 py-4 flex items-center justify-between shadow-sm z-10">
                            <h2 className="text-lg font-semibold text-gray-800">
                                {viewMode === 'dashboard' ? 'Văn Bản Tổng Hợp' : 'Nạp dữ liệu'}
                            </h2>
                            <div className="flex items-center gap-3">
                                {viewMode === 'dashboard' && (
                                    <div className="flex bg-gray-100 rounded-lg p-1 mr-2">
                                        <button onClick={() => setDisplayStyle('document')} className={`p-1.5 rounded-md transition ${displayStyle === 'document' ? 'bg-white shadow text-blue-600' : 'text-gray-500 hover:text-gray-700'}`} title="Chế độ văn bản"><ListIcon className="w-4 h-4" /></button>
                                        <button onClick={() => setDisplayStyle('card')} className={`p-1.5 rounded-md transition ${displayStyle === 'card' ? 'bg-white shadow text-blue-600' : 'text-gray-500 hover:text-gray-700'}`} title="Chế độ thẻ"><GridIcon className="w-4 h-4" /></button>
                                    </div>
                                )}
                                {knowledgeBase.length > 0 && (
                                    <button onClick={handleExportReport} className="flex items-center gap-2 bg-slate-800 hover:bg-slate-900 text-white px-4 py-2 rounded-md text-sm transition shadow-sm">
                                        <Download className="w-4 h-4" /> Tải File Báo Cáo (.txt)
                                    </button>
                                )}
                            </div>
                        </header>

                        <main className="flex-1 overflow-auto p-8 relative bg-gray-100">
                            {viewMode === 'upload' && (
                                <div className="max-w-2xl mx-auto mt-8 space-y-6">
                                    <div className="bg-white p-8 rounded-xl shadow-lg border border-gray-200 text-center">
                                        <div className="mb-4 flex justify-center">
                                            <div className="p-3 bg-blue-50 rounded-full">
                                                <ImagePlus className="w-8 h-8 text-blue-600" />
                                            </div>
                                        </div>
                                        <h3 className="text-lg font-bold text-gray-800 mb-2">Cách 1: Tải File (Hỗ trợ OCR Ảnh)</h3>
                                        <p className="text-gray-500 mb-6 text-sm">
                                            Tài liệu, PDF, Excel, và đặc biệt là <b>Ảnh chụp (OCR tiếng Việt)</b>.
                                            <br/><i>(File backup .json cũng có thể import tại Sidebar)</i>
                                        </p>
                                        
                                        <label className={`inline-block relative ${!libsLoaded ? 'opacity-50 cursor-not-allowed' : ''}`}>
                                            <input 
                                                type="file" 
                                                multiple 
                                                onChange={handleFileUpload} 
                                                className="hidden" 
                                                disabled={isProcessing || !libsLoaded} 
                                                accept=".txt,.md,.csv,.json,.xml,.html,.htm,.js,.css,.srt,.vtt,.pdf,.docx,.xlsx,.xls,.mhtml,.mht,.png,.jpg,.jpeg,.bmp,.webp"
                                            />
                                            <span className={`flex items-center gap-2 cursor-pointer bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium shadow transition`}>
                                                {isProcessing ? <RefreshCw className="animate-spin w-5 h-5"/> : <Upload className="w-5 h-5" />}
                                                {isProcessing ? <span className="loader-dots">Đang xử lý</span> : 'Chọn Files'}
                                            </span>
                                        </label>
                                        {!libsLoaded && <p className="text-xs text-gray-400 mt-2">Cần kết nối mạng để tải bộ đọc OCR.</p>}
                                    </div>

                                    <div className="bg-white p-8 rounded-xl shadow-lg border border-gray-200">
                                        <div className="flex items-center gap-2 mb-4">
                                            <div className="p-2 bg-green-50 rounded-full">
                                                <ListIcon className="w-5 h-5 text-green-600" />
                                            </div>
                                            <h3 className="text-lg font-bold text-gray-800">Cách 2: Nhập Văn Bản Thủ Công</h3>
                                        </div>
                                        <textarea 
                                            value={manualText}
                                            onChange={(e) => setManualText(e.target.value)}
                                            placeholder="Dán nội dung văn bản vào đây..."
                                            className="w-full h-32 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:outline-none mb-3 text-sm"
                                        ></textarea>
                                        <button onClick={handleManualUpload} disabled={!manualText.trim() || isProcessing} className="w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg font-medium transition disabled:opacity-50 flex justify-center items-center gap-2">
                                            <Plus className="w-4 h-4" /> Thêm Dữ Liệu
                                        </button>
                                    </div>

                                    <div className="bg-slate-800 text-green-400 p-4 rounded-lg font-mono text-xs h-48 overflow-y-auto shadow-inner">
                                        {logs.map((log, idx) => <div key={idx} className="mb-1">{log}</div>)}
                                    </div>
                                </div>
                            )}

                            {viewMode === 'dashboard' && (
                                <div className="max-w-4xl mx-auto">
                                    <div className="mb-6 sticky top-0 z-10">
                                        <div className="relative shadow-sm">
                                            <Search className="absolute left-4 top-3.5 text-gray-400 w-5 h-5" />
                                            <input 
                                                type="text" 
                                                placeholder="Tìm kiếm nội dung..."
                                                value={searchTerm}
                                                onChange={(e) => setSearchTerm(e.target.value)}
                                                className="w-full pl-12 pr-4 py-3 bg-white border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition shadow-sm"
                                            />
                                        </div>
                                    </div>

                                    {filteredKB.length === 0 ? (
                                        <div className="text-center py-20 opacity-50">
                                            <FileText className="w-16 h-16 mx-auto mb-4 text-gray-300" />
                                            <p className="text-gray-500">Chưa có dữ liệu báo cáo.</p>
                                        </div>
                                    ) : (
                                        <>
                                            {displayStyle === 'document' ? (
                                                <div className="bg-white shadow-md rounded-none md:rounded-lg min-h-[500px] p-10 md:p-16 border border-gray-200 print:shadow-none print:border-none">
                                                    <div className="text-center mb-10 border-b border-gray-100 pb-6">
                                                        <h1 className="text-2xl font-bold text-slate-800 uppercase mb-2">Báo Cáo Tổng Hợp</h1>
                                                        <p className="text-sm text-gray-500 italic">Ngày xuất: {new Date().toLocaleDateString('vi-VN')}</p>
                                                    </div>
                                                    
                                                    <div className="space-y-8 font-serif md:font-sans text-slate-800">
                                                        {filteredKB.map((group, idx) => (
                                                            <div 
                                                                key={group.id} 
                                                                className={`group/topic transition-all duration-200 ${dragOverGroupId === group.id ? 'droppable-hover p-2 rounded' : ''}`}
                                                                onDragOver={(e) => handleDragOver(e, group.id)}
                                                                onDragLeave={handleDragLeave}
                                                                onDrop={(e) => handleDrop(e, group.id)}
                                                            >
                                                                <div className="flex items-center gap-2 mb-3">
                                                                    {editingId === group.id ? (
                                                                        <div className="flex-1 flex gap-2">
                                                                            <input type="text" value={editValue} onChange={(e) => setEditValue(e.target.value)} className="flex-1 border border-blue-300 rounded px-2 py-1 text-lg font-bold" autoFocus />
                                                                            <button onClick={() => saveTopic(group.id)} className="text-green-600 hover:bg-green-100 p-1 rounded"><Save className="w-5 h-5"/></button>
                                                                            <button onClick={cancelEditing} className="text-red-500 hover:bg-red-100 p-1 rounded"><X className="w-5 h-5"/></button>
                                                                        </div>
                                                                    ) : (
                                                                        <>
                                                                            <h3 className="text-lg font-bold text-slate-900 tracking-wide flex items-center gap-2">
                                                                                {idx + 1}. <HighlightText text={toSentenceCase(group.topic)} highlight={searchTerm} />
                                                                                {group.isManualTopic && <Lock className="w-4 h-4 text-orange-400" title="Đã khóa tên nhóm" />}
                                                                            </h3>
                                                                            <button onClick={() => startEditing(group.id, toSentenceCase(group.topic))} className="opacity-0 group-hover/topic:opacity-100 transition text-gray-400 hover:text-blue-500 p-1" title="Sửa tiêu đề"><Edit2 className="w-4 h-4" /></button>
                                                                        </>
                                                                    )}
                                                                </div>
                                                                <ul className="list-disc pl-6 space-y-2 text-base leading-relaxed text-slate-700">
                                                                    {group.items.map((item) => (
                                                                        <li 
                                                                            key={item.id} 
                                                                            className="pl-2 group/item relative pr-8 flex items-start hover:bg-gray-50 rounded transition-colors"
                                                                            draggable
                                                                            onDragStart={(e) => handleDragStart(e, group.id, item.id)}
                                                                            onDragOver={(e) => e.preventDefault()}
                                                                            onDrop={(e) => handleItemDrop(e, group.id, item.id)}
                                                                        >
                                                                             <span className="opacity-0 group-hover/item:opacity-50 cursor-move mr-2 mt-1" title="Kéo để di chuyển"><GripVertical className="w-4 h-4 text-gray-400"/></span>
                                                                             <div className="flex-1">
                                                                                 {editingId === item.id ? (
                                                                                     <div className="flex gap-2 items-start">
                                                                                        <textarea value={editValue} onChange={(e) => setEditValue(e.target.value)} className="flex-1 border border-blue-300 rounded px-2 py-1 text-base min-h-[60px]" autoFocus></textarea>
                                                                                        <div className="flex flex-col gap-1">
                                                                                            <button onClick={() => saveItem(group.id, item.id)} className="text-green-600 hover:bg-green-100 p-1 rounded"><Save className="w-4 h-4"/></button>
                                                                                            <button onClick={cancelEditing} className="text-gray-500 hover:bg-gray-100 p-1 rounded"><X className="w-4 h-4"/></button>
                                                                                        </div>
                                                                                     </div>
                                                                                 ) : (
                                                                                     <>
                                                                                        <span className={item.isInferred ? "text-blue-900" : ""}>
                                                                                            <HighlightText text={toSentenceCase(item.content)} highlight={searchTerm} />
                                                                                        </span>
                                                                                        {item.isInferred && <span className="text-[10px] text-blue-400 ml-2 select-none" title="Đã được AI phục hồi dấu">(đã phục hồi dấu)</span>}
                                                                                        <span className="text-[10px] text-gray-400 ml-2 select-none">- {item.source}</span>
                                                                                        <div className="absolute top-0 right-0 hidden group-hover/item:flex gap-1 bg-white shadow-sm border rounded p-0.5 z-10">
                                                                                                <button onClick={() => startEditing(item.id, toSentenceCase(item.content))} className="text-gray-400 hover:text-blue-500 p-1" title="Sửa"><Edit2 className="w-3 h-3"/></button>
                                                                                                <button onClick={() => deleteItem(group.id, item.id)} className="text-gray-400 hover:text-red-500 p-1" title="Xóa"><Trash2 className="w-3 h-3"/></button>
                                                                                        </div>
                                                                                     </>
                                                                                 )}
                                                                             </div>
                                                                        </li>
                                                                    ))}
                                                                </ul>
                                                            </div>
                                                        ))}
                                                    </div>
                                                    <div className="mt-16 pt-8 border-t border-gray-100 text-center text-xs text-gray-400">— Hết báo cáo —</div>
                                                </div>
                                            ) : (
                                                <div className="grid gap-4">
                                                    {filteredKB.map((group, idx) => (
                                                        <div 
                                                            key={group.id} 
                                                            className={`bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden transition-all duration-200 ${dragOverGroupId === group.id ? 'droppable-hover' : ''}`}
                                                            onDragOver={(e) => handleDragOver(e, group.id)}
                                                            onDragLeave={handleDragLeave}
                                                            onDrop={(e) => handleDrop(e, group.id)}
                                                        >
                                                            <div className="bg-gray-50 px-4 py-3 border-b border-gray-100 flex justify-between items-center group/cardHeader">
                                                                <h3 className="font-bold text-slate-700 flex items-center gap-2">
                                                                    {idx + 1}. <HighlightText text={toSentenceCase(group.topic)} highlight={searchTerm} />
                                                                    {group.isManualTopic && <Lock className="w-3 h-3 text-orange-400"/>}
                                                                    <button onClick={() => startEditing(group.id, toSentenceCase(group.topic))} className="opacity-0 group-hover/cardHeader:opacity-100 text-gray-400 hover:text-blue-500"><Edit2 className="w-3 h-3"/></button>
                                                                </h3>
                                                                <span className="text-xs bg-white border border-gray-200 px-2 py-1 rounded text-gray-500">{group.items.length} tin</span>
                                                            </div>
                                                            <div className="p-4 space-y-2">
                                                                {group.items.map((item) => (
                                                                    <div 
                                                                        key={item.id} 
                                                                        className="text-sm text-gray-600 pl-2 border-l-2 border-transparent hover:border-blue-300 transition-colors group/cardItem flex justify-between cursor-move"
                                                                        draggable
                                                                        onDragStart={(e) => handleDragStart(e, group.id, item.id)}
                                                                        onDragOver={(e) => e.preventDefault()}
                                                                        onDrop={(e) => handleItemDrop(e, group.id, item.id)}
                                                                    >
                                                                        <span>
                                                                            <HighlightText text={toSentenceCase(item.content)} highlight={searchTerm} />
                                                                            {item.isInferred && <span className="text-xs text-blue-400 ml-2">*</span>}
                                                                        </span>
                                                                        <div className="opacity-0 group-hover/cardItem:opacity-100 flex gap-1">
                                                                            <button onClick={() => startEditing(item.id, toSentenceCase(item.content))}><Edit2 className="w-3 h-3 text-gray-400 hover:text-blue-500"/></button>
                                                                            <button onClick={() => deleteItem(group.id, item.id)}><Trash2 className="w-3 h-3 text-gray-400 hover:text-red-500"/></button>
                                                                        </div>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                        </>
                                    )}
                                </div>
                            )}
                        </main>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
